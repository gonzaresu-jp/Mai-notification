<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WebGL ã‚¯ãƒ­ãƒã‚­ãƒ¼é€éã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #animation-canvas {
            height: 90vh;
            width: auto;
            background-color: transparent; /* WebGLã¯é€éã‚’æ‰±ã†ã®ã§ä¸è¦ã ãŒã€å¿µã®ãŸã‚ */
        }
        #video-source {
            display: none;
        }
    </style>
</head>
<body>

<canvas id="animation-canvas"></canvas>
<video id="video-source" src="showmai.mp4" loop muted playsinline preload="auto"></video>

<script>
window.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('animation-canvas');
    const video = document.getElementById('video-source');
    const gl = canvas.getContext('webgl'); // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—

    if (!gl) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebGLã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }

    // --- WebGLã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ  ---

    // é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ (å››è§’å½¢å…¨ä½“ã‚’æç”»ã™ã‚‹åŸºæœ¬çš„ãªã‚·ã‚§ãƒ¼ãƒ€ãƒ¼)
    const vsSource = `
        attribute vec4 a_position;
        attribute vec2 a_texCoord;
        varying vec2 v_texCoord;
        void main() {
            gl_Position = a_position;
            v_texCoord = a_texCoord;
        }
    `;

    // ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ (ã‚¯ãƒ­ãƒã‚­ãƒ¼å‡¦ç†ã‚’è¡Œã†ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼)
    const fsSource = `
        precision mediump float;
        varying vec2 v_texCoord;
        uniform sampler2D u_image;
        
        // ğŸ’¡ ã‚¯ãƒ­ãƒã‚­ãƒ¼ã®ç·‘è‰² (æ­£è¦åŒ–ã•ã‚ŒãŸRGBå€¤: 0.0-1.0)
        uniform vec3 u_keyColor; 
        // ğŸ’¡ è¨±å®¹èª¤å·® (0.0-1.0, å¤§ãã„ã»ã©åˆ‡ã‚ŠæŠœãç¯„å›²ãŒåºƒã„)
        uniform float u_tolerance;
        // ğŸ’¡ ã‚¨ãƒƒã‚¸ã®ã¼ã‹ã—/æ»‘ã‚‰ã‹ã• (0.0-1.0)
        uniform float u_smoothness;

        void main() {
            vec4 color = texture2D(u_image, v_texCoord); // å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ”ã‚¯ã‚»ãƒ«è‰²ã‚’å–å¾—
            
            // RGBã‚’HSV/HSLã«å¤‰æ›ã™ã‚‹æ–¹ãŒã‚¯ãƒ­ãƒã‚­ãƒ¼ã¯é«˜ç²¾åº¦ã ãŒã€ã“ã“ã§ã¯RGBå·®åˆ†ã§ç°¡ç•¥åŒ–
            // (ã‚ˆã‚Šè¤‡é›‘ãªã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã§ã¯HSV/HSLå¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¨˜è¿°)

            // ç›®æ¨™è‰² (u_keyColor) ã¨ãƒ”ã‚¯ã‚»ãƒ«è‰² (color.rgb) ã®å·®åˆ†ã‚’è¨ˆç®—
            float diff = distance(color.rgb, u_keyColor); 
            
            // ğŸ’¡ ã‚¯ãƒ­ãƒã‚­ãƒ¼å‡¦ç†: è¨±å®¹ç¯„å›²ã«åŸºã¥ã„ã¦ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’èª¿æ•´
            // smoothstep ã¯ã€æŒ‡å®šã—ãŸç¯„å›² (edge0, edge1) ã§æ»‘ã‚‰ã‹ã«0ã‹ã‚‰1ã«å¤‰åŒ–ã™ã‚‹å€¤ã‚’è¿”ã™
            // tolerance ãŒå°ã•ã„ã»ã©å³å¯†ã«ã€smoothness ãŒå¤§ãã„ã»ã©ãƒ•ãƒãŒæ»‘ã‚‰ã‹ã«ãªã‚‹
            float alpha = smoothstep(u_tolerance, u_tolerance + u_smoothness, diff);
            
            // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’æœ€çµ‚çš„ãªè‰²ã«é©ç”¨
            gl_FragColor = vec4(color.rgb, alpha);

            // ğŸ’¡ ãƒ‡ã‚¹ãƒ”ãƒ«ï¼ˆè‰²ã‹ã¶ã‚Šé™¤å»ï¼‰: ç·‘è‰²ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«æ˜ ã‚Šè¾¼ã‚“ã§ã„ã‚‹å ´åˆã€ç·‘æˆåˆ†ã‚’æ¸›ã‚‰ã™
            //    ã“ã‚Œã¯éå¸¸ã«é«˜åº¦ãªå‡¦ç†ã§ã€ä¸Šè¨˜ã®ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã§ã¯å‰²æ„›ã€‚
            //    ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸã‚¯ãƒ­ãƒã‚­ãƒ¼ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã«ã¯å«ã¾ã‚Œã‚‹ã€‚
        }
    `;

    // ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒªãƒ³ã‚¯ (çœç•¥)
    // ... setupShaders(gl, vsSource, fsSource) ...
    const program = createProgram(gl, vsSource, fsSource);
    gl.useProgram(program);

    // ãƒãƒƒãƒ•ã‚¡ã®ä½œæˆ (å››è§’å½¢ã‚’æç”»ã™ã‚‹ãŸã‚ã®é ‚ç‚¹ãƒ‡ãƒ¼ã‚¿)
    const positionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    const positions = [
        -1.0, -1.0, // å·¦ä¸‹
         1.0, -1.0, // å³ä¸‹
        -1.0,  1.0, // å·¦ä¸Š
         1.0,  1.0, // å³ä¸Š
    ];
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);

    // ãƒ†ã‚¯ã‚¹ãƒãƒ£åº§æ¨™ãƒãƒƒãƒ•ã‚¡ã®ä½œæˆ
    const texCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
    const texCoords = [
        0.0, 1.0, // å·¦ä¸‹ (ãƒ†ã‚¯ã‚¹ãƒãƒ£åº§æ¨™ã¯å·¦ä¸ŠãŒåŸç‚¹ãªã®ã§ã€Yã¯åè»¢)
        1.0, 1.0, // å³ä¸‹
        0.0, 0.0, // å·¦ä¸Š
        1.0, 0.0, // å³ä¸Š
    ];
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(texCoords), gl.STATIC_DRAW);

    // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®ä½œæˆ (å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ç”¨)
    const texture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

    // Uniformå¤‰æ•°ã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾— (ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã«å€¤ã‚’æ¸¡ã™ãŸã‚)
    const keyColorLocation = gl.getUniformLocation(program, 'u_keyColor');
    const toleranceLocation = gl.getUniformLocation(program, 'u_tolerance');
    const smoothnessLocation = gl.getUniformLocation(program, 'u_smoothness');

    // ã‚¯ãƒ­ãƒã‚­ãƒ¼ã®ç·‘è‰² (RGBã‚’æ­£è¦åŒ–: 0.0-1.0)
    // ã‚ãªãŸã®å‹•ç”»ã®ç·‘ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ (ä¾‹: GãŒ200ãªã‚‰ 200/255.0)
    const KEY_COLOR_GL = [0.0 / 255.0, 175.0 / 255.0, 0.0 / 255.0]; 
    // è¨±å®¹èª¤å·® (0.0-1.0ã€å¤§ãã„ã»ã©åˆ‡ã‚ŠæŠœããŒåºƒã„)
    const TOLERANCE_GL = 0.2; // 0.1-0.3ç¨‹åº¦ã§èª¿æ•´
    // ã‚¨ãƒƒã‚¸ã®æ»‘ã‚‰ã‹ã• (0.0-1.0ã€å¤§ãã„ã»ã©ãƒ•ãƒãŒã¼ã‚„ã‘ã‚‹)
    const SMOOTHNESS_GL = 0.1; // 0.05-0.2ç¨‹åº¦ã§èª¿æ•´

    gl.uniform3fv(keyColorLocation, new Float32Array(KEY_COLOR_GL));
    gl.uniform1f(toleranceLocation, TOLERANCE_GL);
    gl.uniform1f(smoothnessLocation, SMOOTHNESS_GL);

    video.onloadeddata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

        video.play().catch(error => console.error("å‹•ç”»ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:", error));
        requestAnimationFrame(drawLoop);
    };

    video.onerror = (e) => {
        console.error("å‹•ç”»ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e);
    };

    function drawLoop() {
        if (video.paused || video.ended) {
            requestAnimationFrame(drawLoop);
            return;
        }

        // å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’WebGLãƒ†ã‚¯ã‚¹ãƒãƒ£ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);

        // æç”»
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

        requestAnimationFrame(drawLoop);
    }

    video.load();

    // --- WebGLãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° (çœç•¥) ---
    // createShader, createProgramãªã©ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯ã€å®Ÿéš›ã«ã¯åˆ¥é€”å®šç¾©ãŒå¿…è¦ã§ã™ã€‚
    // https://webglfundamentals.org/webgl/lessons/webgl-boilerplate.html ãªã©ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
    function createShader(gl, type, source) { /* ... */ }
    function createProgram(gl, vsSource, fsSource) { /* ... */ }
});
</script>
</body>
</html>